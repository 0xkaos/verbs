<!DOCTYPE html>
<html >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>לימוד בניינים | Verb Conjugation</title>
  
  <!-- Ionicons CSS -->
  <link href="https://unpkg.com/ionicons@4.5.10-0/dist/css/ionicons.min.css" rel="stylesheet">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Alef&family=Varela+Round&display=swap" rel="stylesheet">
  

  
  <style>
    /* Root Variables for Colors and Fonts */
    :root {
      --font-family: 'Varela Round', Arial, sans-serif;
      --background-color: #F0F1F4;
      --background-image: linear-gradient(to bottom, #F0F1F4, #e0e0e0);
      --text-color: #333;
      --secondary-text-color: #555;
      --primary-color: #364991;
      --accent-color: #ff6600;
      --container-bg: rgba(255, 255, 255, 0.8);
      --container-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      --border-color: #ddd;
      --box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      --input-bg: #fff;
      --input-border-color: #364991;
      --button-bg: #e7e7e7;
      --button-border: #ccc;
      --button-text-color: #333;
      --root-letter-color: #d9534f;
      --root-letter-hover: #ff6600;
    }

    /* Dark Mode Overrides */
    body.dark-mode {
      --background-color: #121212;
      --background-image: none;
      --text-color: #e0e0e0;
      --secondary-text-color: #aaa;
      --container-bg: rgba(30, 30, 30, 0.8);
      --container-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      --border-color: #333;
      --box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      --input-bg: #2a2a2a;
      --input-border-color: #444;
      --button-bg: #444;
      --button-border: #555;
      --button-text-color: #e0e0e0;
      --root-letter-color: #4479b6;
      --root-letter-hover: #6d97c8;
      --accent-color: #8fb0d6; /* Set accent color to blue in dark mode */
    }

    /* Basic Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Body Styles */
    body {
      font-family: var(--font-family);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
      background-color: var(--background-color);
      background-image: var(--background-image);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Container */
    .container {
      width: 100%;
      max-width: 1000px;
      margin: auto;
      padding: 20px;
      background-color: var(--container-bg);
      border-radius: 8px;
      box-shadow: var(--container-shadow);
    }

    /* Header Styles */
    h1 {
      font-family: var(--font-family);
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.6em;
      color: var(--primary-color);
    }

    /* Header Menus */
    .header-menus {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0 auto 20px;
      padding: 0 10px;
      width: 100%;
      max-width: 1000px;
    }

    .header-menus label {
      font-size: 1em;
      margin-right: 10px;
      margin-bottom: 5px;
      color: var(--secondary-text-color);
      text-align: right;
    }

    #translations-list-container {
      flex: 1;
      margin-right: 20px;
      max-width: calc(100% - 300px);
    }

    #verb-select-container {
      flex: 0 0 280px;
      max-width: 100%;
    }

    #translations-list {
      list-style-type: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-start;
    }

    #translations-list li {
      flex: 0 1 auto;
      padding: 5px;
      font-size: 1em;
      color: var(--text-color);
      text-align: center;
    }

    body.dark-mode #translations-list li {
      color: var(--text-color);
    }

    .header-menus select {
      width: 100%;
      max-width: 250px;
      padding: 10px;
      font-size: 1em;
      border: 1px solid var(--input-border-color);
      border-radius: 8px;
      background-color: var(--input-bg);
      color: var(--text-color);
      cursor: pointer;
      appearance: none;
      box-shadow: var(--box-shadow);
      transition: all 0.3s ease;
      text-align: center;
    }

    .header-menus select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    /* Tense Tabs */
    .tense-tabs {
      margin-top: 20px;
      display: flex;
      flex-wrap: nowrap;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      width: 100%;
      max-width: 1000px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      box-shadow: var(--box-shadow);
    }

    /* Buttons */
    .tense-button,
    #dark-mode-toggle {
      font-size: 0.7em;
      padding: 3px 5px;
      margin: 5px;
      border-radius: 4px;
      background-color: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--button-text-color);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tense-button {
      flex: 0 0 auto;
      min-width: 100px;
      text-align: center;
      box-shadow: var(--box-shadow);
      font-size: 1em;
    }

    .tense-button:hover {
      background-color: #ddd;
      transform: scale(1.05);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    body.dark-mode .tense-button:hover {
      background-color: #555;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .tense-button.active {
      background-color: var(--primary-color);
      color: #fff;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    /* Root Letter Highlighting */
    .root-letter {
      font-size: 1.1em;
      font-weight: bold;
      color: var(--root-letter-color);
    }

    .root-letter:hover {
      color: var(--root-letter-hover);
    }

    /* Table Container */
    .table-container {
      width: 100%;
      max-width: 1000px;
      margin-top: 20px;
      overflow-x: auto;
    }

    /* Conjugation Table */
    #conjugation-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--input-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--container-shadow);
      direction: rtl;
    }

    #conjugation-table th,
    #conjugation-table td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      font-size: 1.3em;
    }

    #conjugation-table th {
      background-color: var(--primary-color);
      color: #fff;
      font-weight: bold;
      border-bottom: 2px solid #0056b3;
      font-size: 1em;
    }

    #conjugation-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    body.dark-mode #conjugation-table tr:nth-child(even) {
      background-color: #2a2a2a;
    }

    #conjugation-table tr:hover {
      background-color: #f1f1f1;
    }

    body.dark-mode #conjugation-table tr:hover {
      background-color: #404040;
    }

    #conjugation-table td:nth-child(2) {
      font-size: 1.3em;
    }

    #conjugation-table td:nth-child(2) a {
      color: inherit;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    #conjugation-table td:nth-child(2) a:hover {
      color: var(--accent-color);
    }

    /* Text Elements */
    .header-menus label,
    .info-section ul li strong,
    .info-section ul li em,
    .info-section ul li p,
    .info-section ul li span {
      font-size: 1.1em;
    }

    /* Information Sections */
    .info-section {
      margin-top: 30px;
      width: 100%;
      max-width: 1000px;
    }

    .info-section h2 {
      font-size: 1.5em;
      margin-bottom: 15px;
      padding-bottom: 5px;
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
    }

    /* Cards Layout */
    .info-section ul {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 0;
      margin: 0;
      list-style-type: none;
    }

    .info-section ul li {
      flex: 1 1 calc(33.333% - 20px);
      background-color: var(--input-bg);
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: var(--box-shadow);
      transition: transform 0.3s;
    }

    .info-section ul li:hover {
      transform: translateY(-5px);
      background-color: #f9f9f9;
    }

    body.dark-mode .info-section ul li:hover {
      background-color: #333;
    }

    .info-section ul li strong {
      font-size: 1.1em;
      color: var(--text-color);
      margin-bottom: 10px;
    }

    .info-section ul li em {
      font-size: 1.1em;
      color: var(--secondary-text-color);
      margin-bottom: 10px;
    }

    .info-section ul li p {
      font-size: 1.1em;
      color: var(--text-color);
      margin-bottom: 10px;
    }

    /* Directionality */
    [dir="rtl"] {
      text-align: right;
    }

    [dir="ltr"] {
      text-align: left;
    }

    /* Binyanim Table */
    #binyanim-table {
      width: 100%;
      max-width: 1000px;
      margin-top: 20px;
      border-collapse: collapse;
      background-color: var(--input-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--container-shadow);
    }

    #binyanim-table th,
    #binyanim-table td {
      padding: 15px;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    #binyanim-table th {
      background-color: var(--primary-color);
      color: #fff;
    }

    #binyanim-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }

    body.dark-mode #binyanim-table tr:nth-child(even) {
      background-color: #2a2a2a;
    }

    /* Note Class */
    .note {
      display: block;
      padding: 5px;
      background-color: #f9f9f9;
      color: var(--secondary-text-color);
      font-style: italic;
      text-align: left;
    }
    /* Dark mode adjustments for notes in binyanim table */
    body.dark-mode #binyanim-table .note {
      background-color: #333; /* Slightly lighter than #2a2a2a for contrast */
      color: #aaa; /* Matches --secondary-text-color in dark mode */
    }

    /* Scrollbars for Dark Mode */
    body.dark-mode ::-webkit-scrollbar {
      width: 12px;
    }

    body.dark-mode ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    body.dark-mode ::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 6px;
    }

    body.dark-mode ::-webkit-scrollbar-thumb:hover {
      background: #444;
    }

    /* Font Selector */
    #font-selector {
      font-size: 0.7em;
      padding: 3px 5px;
      margin: 5px;
      border-radius: 4px;
      background-color: var(--button-bg);
      border: 1px solid var(--button-border);
      color: var(--button-text-color);
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--box-shadow);
      appearance: none;
    }

    /* Hover effects to match the button */
    #font-selector:hover {
      background-color: #ddd;
      transform: scale(1.05);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Dark mode styles */
    body.dark-mode #font-selector {
      background-color: var(--button-bg);
      color: var(--button-text-color);
      border: 1px solid var(--button-border);
    }

    body.dark-mode #font-selector:hover {
      background-color: #555;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    li.multiline-item strong,
    li.multiline-item em,
    li.multiline-item p {
      display: block;
      margin-bottom: 5px; /* Optional: Adds spacing between lines */
    }
    #binyan-select-container {
      flex: 0 0 280px;
      max-width: 100%;
      margin-right: 20px; /* Add spacing between binyan and verb menus */
    }

    #binyan-select-container select {
      width: 100%;
      max-width: 250px;
      padding: 10px;
      font-size: 1em;
      border: 1px solid var(--input-border-color);
      border-radius: 8px;
      background-color: var(--input-bg);
      color: var(--text-color);
      cursor: pointer;
      appearance: none;
      box-shadow: var(--box-shadow);
      transition: all 0.3s ease;
      text-align: center;
    }

    #binyan-select-container select:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      #binyan-select-container {
        flex: 0 0 auto;
        margin-right: 0;
        margin-left: 0;
      }

      #binyan-select-container select {
        width: auto;
        max-width: 150px;
        padding: 5px;
        font-size: 0.8em;
        box-shadow: none;
      }

      #binyan-select-container label {
        display: none;
      }
    }

    /* Media Query for Mobile */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      h1 {
        font-size: 1.2em;
      }

      /* Hide the Phonetics column (4th column) */
      #conjugation-table th:nth-child(4),
      #conjugation-table td:nth-child(4) {
        display: none;
      }

      /* Adjust Header Menus */
      .header-menus {
        display: flex;
        flex-wrap: nowrap;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 0;
      }

      /* Adjust Translations List Container */
      #translations-list-container {
        flex: 1 1 auto;
        margin-right: 0;
        max-width: 100%;
        overflow-x: auto;
      }

      /* Adjust Translations List */
      #translations-list {
        display: flex;
        flex-wrap: nowrap;
        gap: 5px;
        justify-content: flex-start;
      }

      /* Adjust Translations List Items */
      #translations-list li {
        flex: 0 0 auto;
        padding: 2px 5px;
        font-size: 0.9em;
        white-space: nowrap;
      }

      /* Adjust Verb Select Container */
      #verb-select-container {
        flex: 0 0 auto;
        margin-left: auto;
      }

      /* Adjust the select element */
      #verb-select-container select {
        width: auto;
        max-width: 150px;
        padding: 5px;
        font-size: 0.8em;
        box-shadow: none;
      }

      /* Optionally hide the label to save space */
      #verb-select-container label {
        display: none;
      }

      /* Adjust Labels */
      .header-menus label {
        font-size: 0.8em;
        margin-right: 5px;
        margin-bottom: 2px;
        color: var(--secondary-text-color);
        text-align: right;
      }

      .header-menus select {
        width: 100%;
        max-width: 200px;
        padding: 5px;
        font-size: 0.8em;
        box-shadow: none;
      }

      #conjugation-table {
        font-size: 0.9em;
      }

      #conjugation-table th,
      #conjugation-table td {
        padding: 5px;
      }

      #conjugation-table th {
        font-size: 0.7em;
      }

      .info-section ul {
        flex-direction: column;
      }

      .info-section ul li {
        flex: 1 1 100%;
        margin-bottom: 10px;
      }

      #dark-mode-toggle {
        font-size: 0.7em;
        padding: 3px 5px;
        margin: 5px 0;
        border-radius: 4px;
        width: auto;
        min-width: 80px;
        max-width: 100px;
      }

      .conjugation-link {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }

      /* Adjust Font Selector */
      #font-selector {
        font-size: 0.9em;
        padding: 5px;
        margin: 5px 0;
        width: 100%;
        max-width: 200px;
      }

      #selected-verb-translation {
        padding: 0 5px;
        font-size: 0.8em;
        color: var(--secondary-text-color);
      }

      .tense-tabs {
        flex-wrap: wrap;
      }

      .tense-button {
        flex: 1 1 calc(33.333% - 15px);
        min-width: auto;
        font-size: 0.7em;
      }
    }
    
    /* Custom Fonts for Hebrew */
    @font-face {
      font-family: 'Noto Rashi Hebrew';
      src: url('fonts/NotoRashiHebrew-VariableFont_wght.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    @font-face {
      font-family: 'Hadasim CLM';
      src: url('fonts/Hadasim CLM Regular.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    @font-face {
      font-family: 'Gveret Levin AlefAlefAlef';
      src: url('fonts/Gveret Levin AlefAlefAlef Regular.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    @font-face {
      font-family: 'Frank Ruehl CLM';
      src: url('fonts/FrankRuehlCLM-Medium.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    @font-face {
      font-family: 'Dorian CLM';
      src: url('fonts/DorianCLM-BookItalic.ttf') format('truetype');
      font-weight: normal;
      font-style: italic;
    }
    @font-face {
      font-family: 'Ktav Yad CLM';
      src: url('fonts/KtavYadCLM-MediumItalic.ttf') format('truetype');
      font-weight: normal;
      font-style: italic;
    }
    @font-face {
      font-family: 'Noto Serif';
      src: url('../fonts/NotoSerifHebrew-VariableFont_wdthwght.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
  </style>
</head>
<body>
  <div class="conjugation-link">
    <a id="returnToFlashcards" href="../index.html">-אב-</a>
    <label for="font-selector"></label>
    <select id="font-selector" data-label="Select Font:">
      <option value="Varela Round">Varela Round</option>
      <option value="Noto Serif">Noto Serif</option>
      <option value="Hadasim CLM">Hadasim CLM</option>
      <option value="Gveret Levin AlefAlefAlef">Gveret Levin AlefAlefAlef</option>
      <option value="Frank Ruehl CLM">Frank Ruehl CLM</option>
      <option value="Dorian CLM">Dorian CLM</option>
      <option value="Ktav Yad CLM">Ktav Yad CLM</option>
    </select>
    <button id="dark-mode-toggle">Dark Mode</button>
  </div>

  <div class="container">
  <h1>לימוד בניינים | Verb Conjugation</h1>
  <div class="header-menus">
    <!-- Translations List Container -->
    <div id="translations-list-container">
      <ul id="translations-list">
        <!-- Translations will be inserted here -->
      </ul>
    </div>
    <!-- Binyan Selection Menu (New) -->
    <div id="binyan-select-container">
      <label for="binyan-select"></label>
      <select id="binyan-select" data-label="Select Binyan:">
        <option value="all">כל הבניינים | All Binyanim</option>
        <!-- Options will be populated dynamically -->
      </select>
    </div>
    <!-- Verb Selection Menu -->
    <div id="verb-select-container">
      <label for="verb-select"></label>
      <select id="verb-select" data-label="Select Verb:">
        <!-- Options will be populated dynamically -->
      </select>
    </div>
  </div>

  <div class="tense-tabs">
    <button class="tense-button active" data-tense="past">עבר | Past</button>
    <button class="tense-button" data-tense="present">הווה | Present</button>
    <button class="tense-button" data-tense="future">עתיד | Future</button>
    <button class="tense-button" data-tense="imperative">ציווי | Imperative</button>
    <button class="tense-button" data-tense="infinitive">מקור | Infinitive</button>
  </div>
</div>

  <div class="table-container">
    <table id="conjugation-table">
      <!-- Table content will be generated by JavaScript -->
    </table>
  </div>

  <div class="info-section" id="examples-section">
    <h2>דוגמאות | Examples</h2>
    <ul id="examples-list">
      <!-- Examples will be populated dynamically -->
    </ul>
  </div>

  <div class="info-section" id="binyanim-section">
    <h2>בניינים | Binyanim</h2>
    <table id="binyanim-table">
      <!-- Table content will be generated by JavaScript -->
    </table>
  </div>

  <div class="info-section" id="notes-section">
    <h2>הערות | Notes</h2>
    <p id="notes-text">
      <!-- Notes will be populated dynamically -->
    </p>
  </div>

  <div class="info-section" id="related-words-section">
    <h2>מילים קשורות | Related Words</h2>
    <ul id="related-words-list">
      <!-- Related words will be populated dynamically -->
    </ul>
  </div>

  <div class="info-section" id="similar-verbs-section">
    <h2>פעלים דומים | Similar Verbs</h2>
    <ul id="similar-verbs-list">
      <!-- Similar verbs will be populated dynamically -->
    </ul>
  </div>

  <div class="info-section" id="idioms-section">
    <h2>ביטויים | Idioms</h2>
    <ul id="idioms-list">
      <!-- Idioms will be populated dynamically -->
    </ul>
  </div>

  <!-- JavaScript -->
  <script>
function playAudio(src) {
  const audio = new Audio(src);
  audio.play();
}

document.addEventListener('DOMContentLoaded', function() {
  let verbs = {}; // Global variable to hold verbs data
  let verbSelect = document.getElementById('verb-select');
  let binyanSelect = document.getElementById('binyan-select');
  let conjugationTable = document.getElementById('conjugation-table');
  let tenseButtons = document.querySelectorAll('.tense-button');
  const fontSelector = document.getElementById('font-selector');
  const body = document.body;
  const returnToFlashcards = document.getElementById('returnToFlashcards');
  const urlParams = new URLSearchParams(window.location.search);
  const returnTo = urlParams.get('returnTo');
  const darkModeToggle = document.getElementById('dark-mode-toggle');

  // New elements for translations list
  const translationsListContainer = document.getElementById('translations-list-container');
  const translationsList = document.getElementById('translations-list');

  // New elements for additional information
  let examplesSection = document.getElementById('examples-section');
  let examplesList = document.getElementById('examples-list');
  let notesSection = document.getElementById('notes-section');
  let notesText = document.getElementById('notes-text');
  let relatedWordsSection = document.getElementById('related-words-section');
  let relatedWordsList = document.getElementById('related-words-list');
  let similarVerbsSection = document.getElementById('similar-verbs-section');
  let similarVerbsList = document.getElementById('similar-verbs-list');
  let idiomsSection = document.getElementById('idioms-section');
  let idiomsList = document.getElementById('idioms-list');
  let binyanimSection = document.getElementById('binyanim-section');
  let binyanimTable = document.getElementById('binyanim-table');

  // Function to play audio pronunciation
  function playAudio(src) {
    const audio = new Audio(src);
    audio.play();
  }

  // Font Selector Change Event
  fontSelector.addEventListener('change', function(e) {
    const selectedFont = e.target.value;
    const fontStyle = selectedFont === 'Dorian CLM' || selectedFont === 'Ktav Yad CLM' ? 'italic' : 'normal';
    body.style.fontFamily = `'${selectedFont}', Arial, sans-serif`;
    body.style.fontStyle = fontStyle;
  });

  // Adjusting the return link based on URL parameters
  if (returnTo) {
    returnToFlashcards.href = returnTo + '/index.html';
  } else {
    returnToFlashcards.href = '../index.html';
  }

  // Normalize Hebrew letters by removing dagesh and vowel marks for comparison
  function normalizeLetter(char) {
    const dageshMap = {
      'בּ': 'ב', 'גּ': 'ג', 'דּ': 'ד', 'כּ': 'כ', 'פּ': 'פ', 'תּ': 'ת',
      'שׁ': 'ש', 'שׂ': 'ש' // Handle shin/sin variation
    };
    return dageshMap[char] || char.replace(/[\u0591-\u05C7\u05BC]/g, ""); // Remove nikkud and dagesh
  }

  // Highlight root letters in a Hebrew verb form, handling weak roots (e.g., ending in ה)
  function highlightRoots(form, rootLetters) {
    if (!form || !rootLetters || rootLetters.length < 2) {
      console.log(`Invalid input: form="${form}", root=${rootLetters}`);
      return form;
    }

    // Normalize root letters and form for comparison
    const normalizedRoot = rootLetters.map(normalizeLetter);
    const formChars = form.split(""); // Split into individual characters
    let consonantPositions = []; // Track positions of all consonants in original form
    let consonants = []; // Store normalized consonants

    // Identify all consonant positions and normalize them
    formChars.forEach((char, idx) => {
      if (/[\u05D0-\u05EA]/.test(char)) { // Match Hebrew letters only
        consonantPositions.push(idx);
        consonants.push(normalizeLetter(char));
      }
    });

    if (consonants.length === 0) {
      console.log(`No consonants found in "${form}" for root ${normalizedRoot}`);
      return form;
    }

    // Handle weak roots (e.g., ending in ה, which may drop in some forms)
    let matchedPositions = [];
    let rootIndex = 0;

    // Try to match root letters in order, allowing for prefixes/suffixes and optional final ה
    for (let i = 0; i < consonants.length && rootIndex < normalizedRoot.length; i++) {
      if (consonants[i] === normalizedRoot[rootIndex]) {
        matchedPositions.push(consonantPositions[i]);
        rootIndex++;
      } else if (rootIndex === normalizedRoot.length - 1 && normalizedRoot[rootIndex] === 'ה') {
        // For weak roots ending in ה, skip if the final ה is missing (common in past/future forms)
        break;
      }
    }

    // If not all root letters matched (except possibly the final ה), try a more lenient approach
    if (rootIndex < normalizedRoot.length - 1 || (rootIndex < normalizedRoot.length && normalizedRoot[rootIndex] !== 'ה')) {
      console.log(`Partial match in "${form}": found ${rootIndex}/${normalizedRoot.length} root letters`);
      matchedPositions = [];
      let lastPos = -1;
      for (let r of normalizedRoot) {
        let found = false;
        for (let i = 0; i < consonants.length; i++) {
          if (consonants[i] === r && consonantPositions[i] > lastPos) {
            matchedPositions.push(consonantPositions[i]);
            lastPos = consonantPositions[i];
            found = true;
            break;
          }
        }
        if (!found && r !== 'ה') { // Allow missing ה as optional
          console.log(`Could not find root letter "${r}" in "${form}"`);
          return form; // Fallback to unhighlighted form
        }
      }
    }

    // Build highlighted string
    let highlightedForm = "";
    for (let i = 0; i < formChars.length; i++) {
      if (matchedPositions.includes(i)) {
        highlightedForm += `<span class="root-letter">${formChars[i]}</span>`;
      } else {
        highlightedForm += formChars[i];
      }
    }

    return highlightedForm;
  }

  // Function to render conjugation table
  function renderTable(verbKey, tense) {
    const verb = verbs[verbKey];
    if (!verb || !verb.conjugations[tense]) {
      conjugationTable.innerHTML = '<tr><td colspan="5">אין נתונים זמינים בזמן זה | No data available for this tense.</td></tr>';
      return;
    }
    let conjugations = verb.conjugations[tense];
    // Define the desired pronoun order
    const desiredPronounOrder = [
      "הוא", // He
      "היא", // She
      "את", // You (f. singular)
      "אתה", // You (m. singular)
      "אני", // I
      "אנחנו", // We
      "אתם", // You (m. plural)
      "אתן", // You (f. plural)
      "הם", // They (m.)
      "הן" // They (f.)
    ];
    // Sort the conjugations array based on the desired pronoun order
    conjugations.sort((a, b) => {
      let indexA = desiredPronounOrder.indexOf(a.pronoun);
      let indexB = desiredPronounOrder.indexOf(b.pronoun);
      if (indexA === -1) indexA = desiredPronounOrder.length;
      if (indexB === -1) indexB = desiredPronounOrder.length;
      return indexA - indexB;
    });
    let rows = [
      '<tr>',
      '<th>גוף | Pronoun</th>',
      '<th>צורה | Form</th>',
      '<th class="ltr">הגייה | Transliteration</th>',
      '<th>פונטיקה | Phonetics</th>',
      '<th>תרגום | Translation</th>',
      '</tr>'
    ];
    for (let item of conjugations) {
      const highlightedForm = highlightRoots(item.form, verb.root);
      if (item.audio) {
        const clickableForm = `<a href="#" onclick="playAudio('${item.audio}'); event.preventDefault();">${highlightedForm}</a>`;
        rows.push(`
          <tr>
            <td>${item.pronoun}</td>
            <td>${clickableForm}</td>
            <td class="ltr">${item.transliteration}</td>
            <td class="ltr">${item.phonetics}</td>
            <td>${item.translation}</td>
          </tr>
        `);
      } else {
        rows.push(`
          <tr>
            <td>${item.pronoun}</td>
            <td>${highlightedForm}</td>
            <td class="ltr">${item.transliteration}</td>
            <td class="ltr">${item.phonetics}</td>
            <td>${item.translation}</td>
          </tr>
        `);
      }
    }
    conjugationTable.innerHTML = rows.join('');
  }

  // Function to toggle dark mode
  function toggleDarkMode() {
    body.classList.toggle('dark-mode');
    const isDarkMode = body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDarkMode);
    darkModeToggle.textContent = isDarkMode ? 'Light Mode' : 'Dark Mode';
    const verbKey = verbSelect.value;
    const tense = document.querySelector('.tense-button.active')?.dataset.tense || 'past';
    renderTable(verbKey, tense);
  }

  // Event listener for the toggle button
  darkModeToggle.addEventListener('click', toggleDarkMode);

  // Check if dark mode was previously enabled
  if (localStorage.getItem('darkMode') === 'true') {
    body.classList.add('dark-mode');
    darkModeToggle.textContent = 'Light Mode';
  }

// Mapping updated with exact spellings from your output
const binyanToEnglish = {
    "פָּעַל": "Paal",      // Matches your output
    "נִפְעַל": "Nifal",    // Matches your output
    "פִּעֵל": "Piel",      // Adjusted to match your output spelling
    "פֻּעַל": "Pual",
    "הִפְעִיל": "Hifil",   // Matches your output
    "הֻפְעַל": "Hufal",
    "הִתְפַּעֵל": "Hitpael" // Adjusted to match your output spelling
};

// Helper function to normalize Hebrew binyan for lookup
function normalizeForLookup(binyan) {
    return binyan.replace(/[\u0591-\u05C7]/g, ''); // Remove all nikkud for fallback
}

function populateBinyanSelect() {
    const binyanMap = new Map(); // Map for normalized (value) -> raw (display) pairs
    for (let verbKey in verbs) {
        const verb = verbs[verbKey];
        if (verb.binyan) {
            const rawBinyan = verb.binyan.trim(); // Original with nikkud for display
            let normalizedBinyan = rawBinyan;
            if (/[\u0591-\u05EA]/.test(rawBinyan)) {
                // Normalize Hebrew for uniqueness, removing specific nikkud
                normalizedBinyan = rawBinyan
                    .replace(/[\u05BC\u05BF]/g, '') // Remove dagesh and rafe
                    .replace(/[\u05B0-\u05B4\u05B6-\u05BB]/g, ''); // Remove most nikkud
            } else {
                // Normalize English (if any) to lowercase
                normalizedBinyan = rawBinyan.toLowerCase();
            }
            binyanMap.set(normalizedBinyan, rawBinyan);
            console.log(`Found binyan for ${verbKey}: ${rawBinyan} -> normalized: ${normalizedBinyan}`);
        }
    }
    const sortedBinyanim = Array.from(binyanMap.keys()).sort();
    binyanSelect.innerHTML = '<option value="all">כל הבניינים | All Binyanim</option>';
    sortedBinyanim.forEach(normalizedBinyan => {
        const rawBinyan = binyanMap.get(normalizedBinyan); // Original with nikkud
        const option = document.createElement('option');
        option.value = normalizedBinyan; // Normalized for functionality
        // Try exact match first, then fallback to normalized lookup
        let englishBinyan = binyanToEnglish[rawBinyan];
        if (!englishBinyan) {
            const normalizedKey = normalizeForLookup(rawBinyan);
            englishBinyan = binyanToEnglish[normalizedKey] || "Unknown";
        }
        option.textContent = `${rawBinyan} | ${englishBinyan}`;
        binyanSelect.appendChild(option);
    });
    console.log('Final binyan options:', sortedBinyanim);
}

  // Function to populate the verb selection dropdown, filtered by raw binyan with nikkud handling
  function populateVerbSelect(binyanFilter = 'all') {
    verbSelect.innerHTML = '';
    for (let verbKey in verbs) {
      const verb = verbs[verbKey];
      // Use the raw binyan value directly, trimmed for spaces, but preserve nikkud for Hebrew
      const verbBinyan = verb.binyan ? verb.binyan.trim() : 'paal'; // Default to paal if missing
      // Check if the binyan is Hebrew and normalize accordingly
      let normalizedVerbBinyan = verbBinyan;
      if (/[\u0591-\u05EA]/.test(verbBinyan)) {
        // For Hebrew binyanim, remove only dagesh and specific nikkud for consistency
        normalizedVerbBinyan = verbBinyan
          .replace(/[\u05BC\u05BF]/g, '') // Remove dagesh (U+05BC) and rafe (U+05BF)
          .replace(/[\u05B0-\u05B4\u05B6-\u05BB]/g, ''); // Remove most nikkud except shva (optional)
      } else {
        // For English binyanim, keep as-is but lowercase
        normalizedVerbBinyan = verbBinyan.toLowerCase();
      }
      if (binyanFilter === 'all' || normalizedVerbBinyan === binyanFilter) {
        const option = document.createElement('option');
        option.value = verbKey;
        // Get the root letters (first three letters)
        let rootText = '';
        if (verb.root && verb.root.length >= 3) {
          rootText = verb.root.slice(0, 3).join('·');
        } else {
          rootText = '???';
        }
        // Get the English translation
        let englishTranslation = '';
        if (verb.translations && verb.translations['en']) {
          englishTranslation = verb.translations['en'];
        } else {
          englishTranslation = 'No translation';
        }
        // Set the option text to include both root letters and English translation
        option.textContent = `${rootText} - ${englishTranslation}`;
        verbSelect.appendChild(option);
      }
    }
    // Reset to the first verb if the list changes
    if (verbSelect.options.length > 0) {
      verbSelect.selectedIndex = 0;
      renderTable(verbSelect.value, 'past');
      renderAdditionalInfo(verbSelect.value);
      renderTranslationsList(verbSelect.value);
    } else {
      renderTable('', 'past'); // Clear table if no verbs match
      renderAdditionalInfo('');
      renderTranslationsList('');
    }
  }

  // Function to add event listeners
  function addEventListeners() {
    // Event listeners for tense buttons
    tenseButtons.forEach(button => {
      button.addEventListener('click', () => {
        tenseButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        const verbKey = verbSelect.value;
        const tense = button.dataset.tense;
        renderTable(verbKey, tense);
      });
    });

    // Event listener for binyan selection
    binyanSelect.addEventListener('change', () => {
      const selectedBinyan = binyanSelect.value;
      populateVerbSelect(selectedBinyan);
    });

    // Event listener for verb selection
    verbSelect.addEventListener('change', () => {
      tenseButtons.forEach(btn => btn.classList.remove('active'));
      tenseButtons[0].classList.add('active');
      const verbKey = verbSelect.value;
      renderTable(verbKey, 'past');
      renderAdditionalInfo(verbKey);
      renderTranslationsList(verbKey);
    });
  }

  function renderAdditionalInfo(verbKey) {
    const verb = verbs[verbKey];

    // Render examples
    examplesList.innerHTML = '';
    if (verb && verb.examples && verb.examples.length > 0) {
      examplesSection.style.display = 'block';
      verb.examples.forEach(example => {
        const listItem = document.createElement('li');
        listItem.className = 'multiline-item'; // Add specific class
        listItem.innerHTML = `
          <strong dir="rtl">${example.hebrew}</strong>
          <em dir="ltr">${example.transliteration}</em>
          <p dir="ltr">${example.translation}</p>
        `;
        examplesList.appendChild(listItem);
      });
    } else {
      examplesSection.style.display = 'none';
    }

    // Render idioms
    idiomsList.innerHTML = '';
    if (verb && verb.idioms && verb.idioms.length > 0) {
      idiomsSection.style.display = 'block';
      verb.idioms.forEach(idiom => {
        const listItem = document.createElement('li');
        listItem.className = 'multiline-item'; // Add specific class
        listItem.innerHTML = `
          <strong dir="rtl">${idiom.expression}</strong>
          <em dir="ltr">(${idiom.transliteration})</em>
          <p dir="ltr">${idiom.translation}</p>
        `;
        idiomsList.appendChild(listItem);
      });
    } else {
      idiomsSection.style.display = 'none';
    }

    // Render related words (unchanged, no multiline-item class)
    relatedWordsList.innerHTML = '';
    if (verb && verb.related_words && verb.related_words.length > 0) {
      relatedWordsSection.style.display = 'block';
      verb.related_words.forEach(word => {
        const listItem = document.createElement('li');
        listItem.setAttribute('dir', 'rtl');
        listItem.textContent = word;
        relatedWordsList.appendChild(listItem);
      });
    } else {
      relatedWordsSection.style.display = 'none';
    }

    // Render similar verbs (unchanged, no multiline-item class)
    similarVerbsList.innerHTML = '';
    if (verb && verb.similar_verbs && verb.similar_verbs.length > 0) {
      similarVerbsSection.style.display = 'block';
      verb.similar_verbs.forEach(similarVerb => {
        const listItem = document.createElement('li');
        listItem.setAttribute('dir', 'rtl');
        listItem.textContent = similarVerb;
        similarVerbsList.appendChild(listItem);
      });
    } else {
      similarVerbsSection.style.display = 'none';
    }

    // Render notes (unchanged)
    if (verb && verb.notes) {
      notesSection.style.display = 'block';
      notesText.setAttribute('dir', 'ltr');
      notesText.textContent = verb.notes;
    } else {
      notesSection.style.display = 'none';
    }

    // Render binyanim
    renderBinyanim(verb ? verb.binyanim : null);
  }

  // Function to render binyanim table
  function renderBinyanim(binyanim) {
    if (binyanim && Object.keys(binyanim).length > 0) {
      binyanimSection.style.display = 'block';
      binyanimTable.innerHTML = `
        <tr>
          <th>בִּנְיָן | Binyan</th>
          <th>שם הפועל | Infinitive</th>
          <th>משמעות | Meaning</th>
        </tr>
      `;
      for (let binyan in binyanim) {
        const binyanData = binyanim[binyan];
        const binyanName = getBinyanNameInHebrew(binyan);
        let meaningContent = binyanData.meaning.join(', ');
        if (binyanData.note) {
          meaningContent += `<span class="note">(${binyanData.note})</span>`;
        }
        binyanimTable.innerHTML += `
          <tr>
            <td>${binyanName} (${binyan})</td>
            <td>${binyanData.infinitive || '-'}</td>
            <td>${meaningContent}</td>
          </tr>
        `;
      }
    } else {
      binyanimSection.style.display = 'none';
    }
  }

  // Helper function to get Hebrew name of binyan
  function getBinyanNameInHebrew(binyan) {
    const binyanNames = {
      "paal": "פָּעַל",
      "nifal": "נִפְעַל",
      "piel": "פִּעֵל",
      "pual": "פֻּעַל",
      "hitpael": "הִתְפַּעֵל",
      "hifil": "הִפְעִיל",
      "hufal": "הֻפְעַל"
    };
    return binyanNames[binyan] || binyan;
  }

  // Function to render translations list for the selected verb
  function renderTranslationsList(verbKey) {
    translationsList.innerHTML = '';
    const verb = verbs[verbKey];
    if (verb && verb.translations) {
      for (let [lang, translation] of Object.entries(verb.translations)) {
        const listItem = document.createElement('li');
        listItem.textContent = `${lang}: ${translation}`;
        translationsList.appendChild(listItem);
      }
    }
  }

  // Fetch verbs data from external JSON file
  fetch('verbs.json')
    .then(response => response.json())
    .then(data => {
      verbs = data;
      populateBinyanSelect();
      populateVerbSelect(); // Initially populate with all verbs
      addEventListeners();
      // Initial rendering
      renderTable(verbSelect.value, 'past');
      renderAdditionalInfo(verbSelect.value);
      renderTranslationsList(verbSelect.value);
    })
    .catch(error => {
      console.error('Error fetching verbs data:', error);
      conjugationTable.innerHTML = '<tr><td colspan="5">שגיאה בטעינת הנתונים | Error loading data.</td></tr>';
    });
});
</script>
</body>
</html>
